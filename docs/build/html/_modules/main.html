<!DOCTYPE html>

<html lang="ru" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>main &#8212; документация Сайт для приюта &#34;Лохматые судъбы&#34; 08.02.2025</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=27fed22d" />
    <script src="../_static/documentation_options.js?v=ab44df89"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/translations.js?v=5b699b7f"></script>
    <link rel="index" title="Алфавитный указатель" href="../genindex.html" />
    <link rel="search" title="Поиск" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Исходный код main</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask_sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask_migrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">Migrate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">Animal</span><span class="p">,</span> <span class="n">Status</span><span class="p">,</span> <span class="n">Media</span><span class="p">,</span> <span class="n">Disease</span><span class="p">,</span> <span class="n">Vaccine</span><span class="p">,</span> <span class="n">Color</span><span class="p">,</span> <span class="n">AnimalType</span><span class="p">,</span> <span class="n">FurType</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">func</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fuzzywuzzy</span><span class="w"> </span><span class="kn">import</span> <span class="n">fuzz</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">openpyxl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">docx</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span><span class="o">,</span><span class="w"> </span><span class="nn">pathlib</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Настройка базы данных SQLite</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sqlite:///animals.db&#39;</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SQLALCHEMY_TRACK_MODIFICATIONS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Инициализация базы данных и миграций</span>
<span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>


<div class="viewcode-block" id="index">
<a class="viewcode-back" href="../index.html#main.index">[документация]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Страница просмотра записей о животных в приюте</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="n">animals</span> <span class="o">=</span> <span class="n">Animal</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">animals_types</span> <span class="o">=</span> <span class="n">AnimalType</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;animalname&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">searchanimaltype</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;searchanimaltype&#39;</span><span class="p">)</span>
        <span class="n">animals_search</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="n">animals</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">animal</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">:</span>
                    <span class="n">animals_search</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">animal</span><span class="p">)</span>
            <span class="n">animals</span> <span class="o">=</span> <span class="n">animals_search</span>
        <span class="k">elif</span> <span class="n">searchanimaltype</span> <span class="o">!=</span> <span class="s2">&quot;кошка/собака&quot;</span><span class="p">:</span>
            <span class="n">type_id</span> <span class="o">=</span> <span class="p">[</span><span class="nb">type</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">animals_types</span> <span class="k">if</span> <span class="nb">type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">searchanimaltype</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="n">animals</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">animal</span><span class="o">.</span><span class="n">animal_type_id</span> <span class="o">==</span> <span class="n">type_id</span><span class="p">:</span>
                    <span class="n">animals_search</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">animal</span><span class="p">)</span>
            <span class="n">animals</span> <span class="o">=</span> <span class="n">animals_search</span>


    <span class="c1"># Преобразование бинарной последовательности из БД в изображение</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">animals</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;static/</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;bw&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">photo</span><span class="p">)</span>
    <span class="c1"># Создаём список ссылок на изображения</span>
    <span class="n">links</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;static/</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.jpg&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">animals</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="n">links</span><span class="p">,</span> <span class="n">animals</span><span class="o">=</span><span class="n">animals</span><span class="p">,</span> <span class="n">animals_types</span><span class="o">=</span><span class="n">animals_types</span><span class="p">)</span></div>



<div class="viewcode-block" id="create">
<a class="viewcode-back" href="../index.html#main.create">[документация]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/create&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Страница создания новой записи о животном в приюте</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">animal</span> <span class="o">=</span> <span class="n">Animal</span><span class="p">(</span>
            <span class="n">photo</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;photo&#39;</span><span class="p">],</span> <span class="s1">&#39;br&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
            <span class="n">animal_type_id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;animal_type_id&#39;</span><span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="n">birth_year</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;birth_year&#39;</span><span class="p">],</span>
            <span class="n">gender</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">],</span>
            <span class="n">color_id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;color_id&#39;</span><span class="p">],</span>
            <span class="n">fur_type_id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;fur_type_id&#39;</span><span class="p">],</span>
            <span class="n">phenotype</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;phenotype&#39;</span><span class="p">],</span>
            <span class="n">description</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">],</span>
            <span class="n">history</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">],</span>
            <span class="n">article_text</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;article_text&#39;</span><span class="p">],</span>
            <span class="n">important</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;important&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;on&#39;</span><span class="p">,</span>
            <span class="n">sterilization</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sterilization&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;on&#39;</span><span class="p">,</span>
            <span class="n">chip</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chip&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;on&#39;</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">animal</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

    <span class="c1"># Получаем данные для выпадающих списков</span>
    <span class="n">animal_types</span> <span class="o">=</span> <span class="n">AnimalType</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">Color</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">fur_types</span> <span class="o">=</span> <span class="n">FurType</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;create.html&#39;</span><span class="p">,</span> <span class="n">animal_types</span><span class="o">=</span><span class="n">animal_types</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">fur_types</span><span class="o">=</span><span class="n">fur_types</span><span class="p">)</span></div>



<div class="viewcode-block" id="edit">
<a class="viewcode-back" href="../index.html#main.edit">[документация]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/edit/&lt;int:id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">edit</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Страница редактирования записи о животном в приюте</span>

<span class="sd">    :ivar id: индекс животного в базе данных</span>
<span class="sd">    :vartype id: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">animal</span> <span class="o">=</span> <span class="n">Animal</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">animal</span><span class="o">.</span><span class="n">photo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;photo&#39;</span><span class="p">],</span> <span class="s1">&#39;br&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">animal</span><span class="o">.</span><span class="n">animal_type_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;animal_type_id&#39;</span><span class="p">]</span>
        <span class="n">animal</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">animal</span><span class="o">.</span><span class="n">birth_year</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;birth_year&#39;</span><span class="p">]</span>
        <span class="n">animal</span><span class="o">.</span><span class="n">gender</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span>
        <span class="n">animal</span><span class="o">.</span><span class="n">color_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;color_id&#39;</span><span class="p">]</span>
        <span class="n">animal</span><span class="o">.</span><span class="n">fur_type_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;fur_type_id&#39;</span><span class="p">]</span>
        <span class="n">animal</span><span class="o">.</span><span class="n">phenotype</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;phenotype&#39;</span><span class="p">]</span>
        <span class="n">animal</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
        <span class="n">animal</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">]</span>
        <span class="n">animal</span><span class="o">.</span><span class="n">article_text</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;article_text&#39;</span><span class="p">]</span>

        <span class="c1"># Обновляем булевы значения</span>
        <span class="n">animal</span><span class="o">.</span><span class="n">important</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;important&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;on&#39;</span>
        <span class="n">animal</span><span class="o">.</span><span class="n">sterilization</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sterilization&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;on&#39;</span>
        <span class="n">animal</span><span class="o">.</span><span class="n">chip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chip&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;on&#39;</span>

        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>

    <span class="c1"># Получаем данные для выпадающих списков</span>
    <span class="n">animal_types</span> <span class="o">=</span> <span class="n">AnimalType</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">Color</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">fur_types</span> <span class="o">=</span> <span class="n">FurType</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;edit.html&#39;</span><span class="p">,</span> <span class="n">animal</span><span class="o">=</span><span class="n">animal</span><span class="p">,</span>
                           <span class="n">animal_types</span><span class="o">=</span><span class="n">animal_types</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">fur_types</span><span class="o">=</span><span class="n">fur_types</span><span class="p">)</span></div>


<div class="viewcode-block" id="animal_detail">
<a class="viewcode-back" href="../index.html#main.animal_detail">[документация]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/detail/&lt;int:id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">animal_detail</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Страница просмотра подробной информации о животном</span>

<span class="sd">        :ivar id: индекс животного в базе данных</span>
<span class="sd">        :vartype id: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="n">animal</span> <span class="o">=</span> <span class="n">Animal</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">animal_types</span> <span class="o">=</span> <span class="n">AnimalType</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">Color</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">fur_types</span> <span class="o">=</span> <span class="n">FurType</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">link</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/static/</span><span class="si">{</span><span class="n">animal</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.jpg&quot;</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;animal_detail.html&#39;</span><span class="p">,</span> <span class="n">animal</span><span class="o">=</span><span class="n">animal</span><span class="p">,</span>
                           <span class="n">animal_types</span><span class="o">=</span><span class="n">animal_types</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">fur_types</span><span class="o">=</span><span class="n">fur_types</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="n">link</span><span class="p">)</span></div>



<div class="viewcode-block" id="delete">
<a class="viewcode-back" href="../index.html#main.delete">[документация]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/delete/&lt;int:id&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Функия удаления записи о животном в приюте</span>

<span class="sd">        :ivar id: индекс животного в базе данных</span>
<span class="sd">        :vartype id: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="n">animal</span> <span class="o">=</span> <span class="n">Animal</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">animal</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span></div>


<span class="n">close_open_list</span> <span class="o">=</span> <span class="kc">True</span>
<div class="viewcode-block" id="admin">
<a class="viewcode-back" href="../index.html#main.admin">[документация]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/admin&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">admin</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Страница редактирования записи о животном в приюте</span>

<span class="sd">        :ivar close_open_list: глобальноя переменная-флаг сворачивания и разворачивания списка животных в приюте</span>
<span class="sd">        :vartype close_open_list: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">close_open_list</span>
    <span class="n">animals</span> <span class="o">=</span> <span class="n">Animal</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">animals_types</span> <span class="o">=</span> <span class="n">AnimalType</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">animal_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">animals</span><span class="p">)</span>
    <span class="n">links</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;static/</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.jpg&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">animals</span><span class="p">}</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sizes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">type_name</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">AnimalType</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">Animal</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Animal</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span>
        <span class="n">AnimalType</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()):</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">type_name</span><span class="p">)</span>
        <span class="n">sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>


    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">sizes</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Количество животных по типам&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Тип животного&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Количество&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;static/image.png&#39;</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">close_open_list</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;animalname&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">searchanimaltype</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;searchanimaltype&#39;</span><span class="p">)</span>
        <span class="n">animals_search</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="n">animals</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">animal</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">:</span>
                    <span class="n">animals_search</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">animal</span><span class="p">)</span>
            <span class="n">animals</span> <span class="o">=</span> <span class="n">animals_search</span>
        <span class="k">elif</span> <span class="n">searchanimaltype</span> <span class="o">!=</span> <span class="s2">&quot;кошка/собака&quot;</span><span class="p">:</span>
            <span class="n">type_id</span> <span class="o">=</span> <span class="p">[</span><span class="nb">type</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">animals_types</span> <span class="k">if</span> <span class="nb">type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">searchanimaltype</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="n">animals</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">animal</span><span class="o">.</span><span class="n">animal_type_id</span> <span class="o">==</span> <span class="n">type_id</span><span class="p">:</span>
                    <span class="n">animals_search</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">animal</span><span class="p">)</span>
            <span class="n">animals</span> <span class="o">=</span> <span class="n">animals_search</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;admin.html&#39;</span><span class="p">,</span> <span class="n">animals</span><span class="o">=</span><span class="n">animals</span><span class="p">,</span> <span class="n">animal_count</span><span class="o">=</span><span class="n">animal_count</span><span class="p">,</span> <span class="n">links</span> <span class="o">=</span> <span class="n">links</span><span class="p">,</span> <span class="n">animals_types</span><span class="o">=</span><span class="n">animals_types</span><span class="p">,</span> <span class="n">close_open_list</span><span class="o">=</span><span class="n">close_open_list</span><span class="p">)</span></div>


<div class="viewcode-block" id="close_open_list">
<a class="viewcode-back" href="../index.html#main.close_open_list">[документация]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/close_open_list&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">close_open_list</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Функция сворачивания и разворачивания списка животных в приюте</span>

<span class="sd">            :ivar close_open_list: глобальноя переменная-флаг сворачивания и разворачивания списка животных в приюте</span>
<span class="sd">            :vartype close_open_list: bool</span>
<span class="sd">            &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">close_open_list</span>
    <span class="k">if</span> <span class="n">close_open_list</span><span class="p">:</span>
        <span class="n">close_open_list</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">close_open_list</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="yes_or_no">
<a class="viewcode-back" href="../index.html#main.yes_or_no">[документация]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">yes_or_no</span><span class="p">(</span><span class="n">parametr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Функция преобразования строк &quot;да&quot; и &quot;нет&quot; в соответствующие булевские значения</span>

<span class="sd">            :ivar parametr: строка</span>
<span class="sd">            :vartype parametr: string</span>
<span class="sd">            &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">parametr</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">parametr</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;да&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="import_animals">
<a class="viewcode-back" href="../index.html#main.import_animals">[документация]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/import&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">import_animals</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Функция импорта данных о животных в приюте из таблицы xlsx</span>

<span class="sd">                &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;file&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

    <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">file</span><span class="p">:</span>


        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;instance/animals.db&#39;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="c1"># читаем excel-файл</span>
        <span class="n">wb</span> <span class="o">=</span> <span class="n">openpyxl</span><span class="o">.</span><span class="n">load_workbook</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="c1"># печатаем список листов</span>
        <span class="n">sheets</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">sheetnames</span>
        <span class="k">for</span> <span class="n">sheet</span> <span class="ow">in</span> <span class="n">sheets</span><span class="p">:</span>
            <span class="n">cat_data</span> <span class="o">=</span> <span class="n">wb</span><span class="p">[</span><span class="n">sheet</span><span class="p">]</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">cat_data</span><span class="p">[</span><span class="s1">&#39;B1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">birth_year</span> <span class="o">=</span> <span class="n">cat_data</span><span class="p">[</span><span class="s1">&#39;B2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">gender</span> <span class="o">=</span> <span class="n">cat_data</span><span class="p">[</span><span class="s1">&#39;B3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">phenotype</span> <span class="o">=</span> <span class="n">cat_data</span><span class="p">[</span><span class="s1">&#39;B4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">cat_data</span><span class="p">[</span><span class="s1">&#39;B5&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">fur_type</span> <span class="o">=</span> <span class="n">cat_data</span><span class="p">[</span><span class="s1">&#39;B6&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="c1"># __________________________________________</span>
            <span class="n">scratching_post</span> <span class="o">=</span> <span class="n">yes_or_no</span><span class="p">(</span><span class="n">cat_data</span><span class="p">[</span><span class="s1">&#39;B7&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">lotochek</span> <span class="o">=</span> <span class="n">yes_or_no</span><span class="p">(</span><span class="n">cat_data</span><span class="p">[</span><span class="s1">&#39;B8&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">possible_dogs</span> <span class="o">=</span> <span class="n">yes_or_no</span><span class="p">(</span><span class="n">cat_data</span><span class="p">[</span><span class="s1">&#39;B9&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">possible_cats</span> <span class="o">=</span> <span class="n">yes_or_no</span><span class="p">(</span><span class="n">cat_data</span><span class="p">[</span><span class="s1">&#39;B10&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">sterilization</span> <span class="o">=</span> <span class="n">yes_or_no</span><span class="p">(</span><span class="n">cat_data</span><span class="p">[</span><span class="s1">&#39;B11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">vaccinated</span> <span class="o">=</span> <span class="n">yes_or_no</span><span class="p">(</span><span class="n">cat_data</span><span class="p">[</span><span class="s1">&#39;B12&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">chip</span> <span class="o">=</span> <span class="n">yes_or_no</span><span class="p">(</span><span class="n">cat_data</span><span class="p">[</span><span class="s1">&#39;B13&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">have_passport</span> <span class="o">=</span> <span class="n">yes_or_no</span><span class="p">(</span><span class="n">cat_data</span><span class="p">[</span><span class="s1">&#39;B14&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">free</span> <span class="o">=</span> <span class="n">yes_or_no</span><span class="p">(</span><span class="n">cat_data</span><span class="p">[</span><span class="s1">&#39;B15&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="c1"># __________________________________________</span>
            <span class="n">article_text</span> <span class="o">=</span> <span class="n">cat_data</span><span class="p">[</span><span class="s1">&#39;B16&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">important</span> <span class="o">=</span> <span class="n">yes_or_no</span><span class="p">(</span><span class="n">cat_data</span><span class="p">[</span><span class="s1">&#39;B17&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">history</span> <span class="o">=</span> <span class="n">cat_data</span><span class="p">[</span><span class="s1">&#39;B18&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;UPDATE Animal SET </span>
<span class="s1">            birth_year = ?,</span>
<span class="s1">            gender = ?,</span>
<span class="s1">            phenotype = ?, </span>
<span class="s1">            color = ?,</span>
<span class="s1">            fur_type = ?, </span>
<span class="s1">            scratching_post = ?, </span>
<span class="s1">            lotochek = ?, </span>
<span class="s1">            possible_dogs = ?, </span>
<span class="s1">            possible_cats = ?, </span>
<span class="s1">            sterilization = ?, </span>
<span class="s1">            vaccinated = ?, </span>
<span class="s1">            chip = ?, </span>
<span class="s1">            have_passport = ?, </span>
<span class="s1">            free = ?, </span>
<span class="s1">            article_text = ?, </span>
<span class="s1">            important = ?, </span>
<span class="s1">            history = ? </span>
<span class="s1">            WHERE name = ?&#39;&#39;&#39;</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">birth_year</span><span class="p">,</span>
                            <span class="n">gender</span><span class="p">,</span>
                            <span class="n">phenotype</span><span class="p">,</span>
                            <span class="n">color</span><span class="p">,</span>
                            <span class="n">fur_type</span><span class="p">,</span>
                            <span class="n">scratching_post</span><span class="p">,</span>
                            <span class="n">lotochek</span><span class="p">,</span>
                            <span class="n">possible_dogs</span><span class="p">,</span>
                            <span class="n">possible_cats</span><span class="p">,</span>
                            <span class="n">sterilization</span><span class="p">,</span>
                            <span class="n">vaccinated</span><span class="p">,</span>
                            <span class="n">chip</span><span class="p">,</span>
                            <span class="n">have_passport</span><span class="p">,</span>
                            <span class="n">free</span><span class="p">,</span>
                            <span class="n">article_text</span><span class="p">,</span>
                            <span class="n">important</span><span class="p">,</span>
                            <span class="n">history</span><span class="p">,</span>
                            <span class="n">name</span><span class="p">))</span>

        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="extract_images">
<a class="viewcode-back" href="../index.html#main.extract_images">[документация]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_images</span><span class="p">(</span><span class="n">docx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Функция извлечения изображений из документов word</span>

<span class="sd">                &quot;&quot;&quot;</span>
    <span class="c1"># директория для извлечения</span>
    <span class="n">ex_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pic_</span><span class="si">{</span><span class="n">docx</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ex_dir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="n">ex_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">docx</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">zf</span><span class="o">.</span><span class="n">infolist</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;word/media&#39;</span><span class="p">):</span>
                <span class="c1"># здесь можно задать другие параметры фильтрации,</span>
                <span class="c1"># например отобрать картинки с определенном именем,</span>
                <span class="c1"># расширением, размером `name.file_size` и т.д.</span>
                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">:</span>
                    <span class="n">name</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.jpeg&#39;</span>
                <span class="n">zf</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ex_dir</span><span class="p">)</span></div>


<div class="viewcode-block" id="extract_text">
<a class="viewcode-back" href="../index.html#main.extract_text">[документация]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_text</span><span class="p">(</span><span class="n">docx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Функция извлечения текста из документов word</span>

<span class="sd">                    &quot;&quot;&quot;</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span><span class="n">docx</span><span class="p">)</span>
    <span class="c1"># последовательность всех таблиц документа</span>
    <span class="n">all_tables</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">tables</span>

    <span class="c1"># создаем пустой словарь под данные таблиц</span>
    <span class="n">data_tables</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_tables</span><span class="p">))}</span>
    <span class="c1"># проходимся по таблицам</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_tables</span><span class="p">):</span>
        <span class="c1"># создаем список строк для таблицы `i` (пока пустые)</span>
        <span class="n">data_tables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">rows</span><span class="p">))]</span>
        <span class="c1"># проходимся по строкам таблицы `i`</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">rows</span><span class="p">):</span>
            <span class="c1"># проходимся по ячейкам таблицы `i` и строки `j`</span>
            <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
                <span class="c1"># добавляем значение ячейки в соответствующий</span>
                <span class="c1"># список, созданного словаря под данные таблиц</span>
                <span class="n">data_tables</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="c1"># смотрим извлеченные данные</span>
        <span class="c1"># (по строкам) для таблицы `i`</span>

    <span class="k">return</span> <span class="n">data_tables</span></div>



<div class="viewcode-block" id="import_animals_docx">
<a class="viewcode-back" href="../index.html#main.import_animals_docx">[документация]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/import_docs&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">import_animals_docx</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Функция импорта информации о животных в приюте из документов word</span>

<span class="sd">                    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;file&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

    <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">file</span><span class="p">:</span>

        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;instance/animals.db&#39;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">extract_images</span><span class="p">(</span><span class="s1">&#39;cats.docx&#39;</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">extract_text</span><span class="p">(</span><span class="s1">&#39;cats.docx&#39;</span><span class="p">)</span>
        <span class="n">text_cat</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">text_dog</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text_cat</span><span class="p">)):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pic_cats.docx/word/media/image</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">.jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">photo</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">animal_type_id</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">text_cat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;INSERT INTO Animal (photo, animal_type_id, name) VALUES (?, ?, ?)&#39;</span><span class="p">,</span>
                               <span class="p">(</span><span class="n">photo</span><span class="p">,</span> <span class="n">animal_type_id</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text_dog</span><span class="p">)):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pic_cats.docx/word/media/image</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">text_cat</span><span class="p">)</span><span class="si">}</span><span class="s1">.jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">photo</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">animal_type_id</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">text_dog</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;INSERT INTO Animal (photo, animal_type_id, name) VALUES (?, ?, ?)&#39;</span><span class="p">,</span>
                               <span class="p">(</span><span class="n">photo</span><span class="p">,</span> <span class="n">animal_type_id</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">))</span></div>



<div class="viewcode-block" id="statistics">
<a class="viewcode-back" href="../index.html#main.statistics">[документация]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/statistics&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">statistics</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Функция генерации графика тип животного-количество животных</span>

<span class="sd">                    :return: Изображение графика тип животного-количество животных</span>
<span class="sd">                    :rtype: файл формата png</span>

<span class="sd">                    &quot;&quot;&quot;</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sizes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">func</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">type_name</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">AnimalType</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">Animal</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Animal</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span>
        <span class="n">AnimalType</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()):</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">type_name</span><span class="p">)</span>
        <span class="n">sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">sizes</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Количество животных по типам&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Тип животного&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Количество&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;image.png&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;image.png&#39;</span></div>




<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>  <span class="c1"># Создаем контекст приложения</span>
        <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Сайт для приюта "Лохматые судъбы"</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Искать" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Навигация</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Код модуля</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, С.С. Александрова.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>